name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  basic-test:
    name: Basic Functionality Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1 ffmpeg

    - name: Install core dependencies only
      run: |
        python -m pip install --upgrade pip
        pip install numpy==1.24.3
        pip install opencv-python-headless==4.8.1.78
        pip install Pillow==10.0.1
        pip install PyYAML==6.0.1

    - name: Test core imports
      run: |
        python -c "import cv2; print(f'✅ OpenCV {cv2.__version__} works')"
        python -c "import numpy as np; print(f'✅ NumPy {np.__version__} works')"
        python -c "import yaml; print('✅ PyYAML works')"
        python -c "from PIL import Image; print('✅ Pillow works')"

    - name: Test project structure
      run: |
        python -c "
        import os
        required_files = ['main_app.py', 'run_app.py', 'README.md', 'INSTALL.md']
        for file in required_files:
            if os.path.exists(file):
                print(f'✅ {file} exists')
            else:
                print(f'❌ {file} missing')
                exit(1)
        print('✅ Project structure is valid')
        "

    - name: Test tools directory
      run: |
        python -c "
        import os
        tools_files = ['tools/install.py', 'tools/check_requirements.py']
        for file in tools_files:
            if os.path.exists(file):
                print(f'✅ {file} exists')
            else:
                print(f'❌ {file} missing')
                exit(1)
        print('✅ Tools directory is valid')
        "

  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Check Python syntax
      run: |
        python -m py_compile main_app.py
        python -m py_compile run_app.py
        echo "✅ Main Python files have valid syntax"
        
        # Check if tools files exist and have basic syntax
        if [ -f "tools/install.py" ]; then
          echo "✅ tools/install.py exists"
        fi
        
        if [ -f "tools/check_requirements.py" ]; then
          echo "✅ tools/check_requirements.py exists"
        fi
        
        echo "✅ All syntax checks completed"

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check documentation files
      run: |
        if [ -f "README.md" ]; then
          echo "✅ README.md exists"
          if [ $(wc -l < README.md) -gt 50 ]; then
            echo "✅ README.md is comprehensive ($(wc -l < README.md) lines)"
          else
            echo "⚠️ README.md might be too short"
          fi
        else
          echo "❌ README.md missing"
          exit 1
        fi
        
        if [ -f "INSTALL.md" ]; then
          echo "✅ INSTALL.md exists"
        else
          echo "❌ INSTALL.md missing"
          exit 1
        fi
        
        if [ -f "LICENSE" ]; then
          echo "✅ LICENSE exists"
        else
          echo "❌ LICENSE missing"
          exit 1
        fi